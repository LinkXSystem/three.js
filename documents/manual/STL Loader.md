# STL Loader

> STL 文件的 wiki 的[地址](https://en.wikipedia.org/wiki/STL_file)

## 文件格式的结构

STL文件是一种用许多空间小三角形面片逼近三维实体表面的数据模型，STL模型的数据通过给出组成三角形法向量的3个分量(用于确定三角面片的正反方向)及三角形的3个顶点坐标来实现，一个完整的STL文件记载了组成实体模型的所有三角形面片的法向量数据和顶点坐标数据信息。目前的STL文件格式包括二进制文件(BINARY)和文本文件(ASCII)两种。

- STL的二进制格式

    二进制 STL 文件用固定的字节数来给出三角面片的几何信息。文件起始的80个字节是文件头，用于存贮零件名；紧接着用4个字节的整数来描述模型的三角面片个数，后面逐个给出每个三角面片的几何信息。每个三角面片占用固定的 50个字节，依次是3个4字节浮点数(角面片的法矢量)，3个4字节浮点数(1个顶点的坐标)，3个4字节浮点数(2个顶点的坐标)，3个4字节浮点数(3个顶点的坐标)，最后2个字节用来描述三角面片的属性信息。一个完整二进制STL文件的大小为三角形面片数乘以50再加上84个字节，总共134个字节。

    ```shell
    UINT8[80]         -   Header
    UINT32            -   Number of triangles
    foreach triangle
        REAL32[3]       -    Normal vector
        REAL32[3]       -    Vertex 1
        REAL32[3]       -    Vertex 2
        REAL32[3]       -    Vertex 3
        UINT16          -    Attribute byte count
    end
    ```

- STL 的 ASCII 文件格式

    ASCII 码格式的 STL 文件逐行给出三角面片的几何信息，每一行以1个或2个关键字开头。在 STL 文件中的三角面片的信息单元 facet 是一个带矢量方向的三角面片，STL 三维模型就是由一系列这样的三角面片构成。整个STL文件的首行给出了文件路径及文件名。在一个 STL 文件中，每一个 facet 由7行数据组成，facetnormal 是三角面片指向实体外部的法矢量坐标，outer loop 说明随后的3行数据分别是三角面片的3个顶点坐标，3顶点沿指向实体外部的法矢量方向逆时针排列。

    ```shell
    facet normal -0.761249 0.041314 -0.647143  // 三角面片法向量的 3 个分量值
      outer loop
        vertex -0.075633 -0.095256 -0.057711   // 三角面片第一个顶点的坐标
        vertex -0.078756 -0.079398 -0.053025   // 三角面片第二个顶点的坐标
        vertex -0.074338 -0.088143 -0.058780   // 三角面片第三个顶点的坐标
      endloop
    endfacet
    ```

通过对STL两种文件格式的分析可知，二进制格式文件较小(通常是ASCII码格式的1／5)，节省文件存储空间，而 ASCII 码格式的文件可读性更强，更容易进行进一步的数据处理。

## 三角片法矢量的计算

读取STL文件时，只需要读取STL文件中表示向量和三角形顶点的相应数据，不需要读文件中的其它信息。依次按逆时针方向读入各个三角形面片的3顶点坐标值。由于三角面片外法矢量可以通过右手螺旋法则由3顶点坐标值计算出来，因此可不对其进行存储，以节省存储空间。如果后续处理需用到法矢量，

可利用以下的外法矢量计算公式：

$$
n_x = (v1_y - v3_y)(v2_z - v3_z) - (v1_z - v3_z)(v2_y - v3_y)
\\
n_y = (v1_z - v3_z)(v2_x - v3_x) - (v2_z - v3_z)(v1_x - v3_x)
\\
n_z = (v1_x - v3_x)(v2_y - v3_y) - (v2_x - v3_x)(v1_y - v3_y)
$$

## Three.js 中的使用

样例代码：

```js
import { STLLoader } from 'three/examples/jsm/loaders/STLLoader';

const loader = new STLLoader();
loader.load(link, function (geometry) {
    // geometry : 几何体
    ......
});
```

## STL Loader 的代码解析

待定
